From 180c33f9c88bab26a0faea298f06c0c54cf6e652 Mon Sep 17 00:00:00 2001
From: jiangcuo <jiangcuo@bingsin.com>
Date: Mon, 3 Feb 2025 15:07:03 +0800
Subject: [PATCH 7/9] Adjust some code so that it can pass the test on the
 x86_64 platform.

---
 PVE/QemuServer.pm           |  27 +++---
 PVE/QemuServer/CPUConfig.pm |  19 ++--
 PVE/QemuServer/PCI.pm       | 170 ++++++++++++++++++------------------
 3 files changed, 108 insertions(+), 108 deletions(-)

diff --git a/PVE/QemuServer.pm b/PVE/QemuServer.pm
index 56ecb1cd..d45db7a9 100644
--- a/PVE/QemuServer.pm
+++ b/PVE/QemuServer.pm
@@ -3616,7 +3616,7 @@ sub config_to_command {
 	push $cmd->@*, '-drive', $var_drive_str;
     }
 
-    if ($q35) { # tell QEMU to load q35 config early
+    if ($q35 && $arch eq 'x86_64') { # tell QEMU to load q35 config early
 	# we use different pcie-port hardware for qemu >= 4.0 for passthrough
 	if (min_version($machine_version, 4, 0)) {
 	    push @$devices, '-readconfig', '/usr/share/qemu-server/pve-q35-4.0.cfg';
@@ -3624,6 +3624,9 @@ sub config_to_command {
 	    push @$devices, '-readconfig', '/usr/share/qemu-server/pve-q35.cfg';
 	}
     }
+	if ($arch ne 'x86_64') { 
+        unshift @$devices, '-readconfig', '/usr/share/qemu-server/pve-port.cfg';
+    }
 
     if (defined(my $fixups = qemu_created_version_fixups($conf, $forcemachine, $kvmver))) {
 	push @$cmd, $fixups->@*;
@@ -4055,9 +4058,6 @@ sub config_to_command {
 		}
 		}
 	}
-	if ($arch ne 'x86_64') { 
-        unshift @$devices, '-readconfig', '/usr/share/qemu-server/pve-port.cfg';
-    }
 
     if (!$kvm) {
 	push @$machineFlags, 'accel=tcg';
@@ -4071,15 +4071,6 @@ sub config_to_command {
 
     PVE::QemuServer::Machine::assert_valid_machine_property($machine_conf);
 
-    if (my $viommu = $machine_conf->{viommu}) {
-	if ($viommu eq 'intel' && ($arch eq 'x86_64')) {
-	    unshift @$devices, '-device', 'intel-iommu,intremap=on,caching-mode=on';
-	    push @$machineFlags, 'kernel-irqchip=split';
-	} elsif ($viommu eq 'virtio') {
-	    push @$devices, '-device', 'virtio-iommu-pci';
-	}
-    }
-
 	my $gicv = $kvm ? 'host' : 'max';
     if ( $conf->{gicversion} ) {
         $gicv = $conf->{gicversion};
@@ -4091,6 +4082,16 @@ sub config_to_command {
     	push @$machineFlags, "type=${machine_type_min}";
     }
 
+    if (my $viommu = $machine_conf->{viommu}) {
+	if ($viommu eq 'intel' && ($arch eq 'x86_64')) {
+	    unshift @$devices, '-device', 'intel-iommu,intremap=on,caching-mode=on';
+	    push @$machineFlags, 'kernel-irqchip=split';
+	} elsif ($viommu eq 'virtio') {
+	    push @$devices, '-device', 'virtio-iommu-pci';
+	}
+    }
+
+
     if ($conf->{'amd-sev'} && ($arch eq 'x86_64')) {
 	push @$devices, '-object', get_amd_sev_object($conf->{'amd-sev'}, $conf->{bios});
 	push @$machineFlags, 'confidential-guest-support=sev0';
diff --git a/PVE/QemuServer/CPUConfig.pm b/PVE/QemuServer/CPUConfig.pm
index 01f92282..2322103d 100644
--- a/PVE/QemuServer/CPUConfig.pm
+++ b/PVE/QemuServer/CPUConfig.pm
@@ -213,7 +213,7 @@ my $cpu_fmt = {
 	    ." Only valid for custom CPU model definitions, default models will always report themselves to the guest OS.",
 	type => 'string',
 	enum => [ sort { lc("$a") cmp lc("$b") } keys %$cpu_vendor_list ],
-	default => 'max',
+	default => 'kvm64',
 	optional => 1,
     },
     hidden => {
@@ -794,15 +794,14 @@ sub get_default_cpu_type {
     my ($arch, $kvm) = @_;
 
     # if !kvm ,cpu will set to max for all arch
-    my $cputype = 'max';
-    if ($kvm){
-    $cputype = 'host' if $arch eq 'x86_64';
-    $cputype = 'host' if $arch eq 'aarch64';
-    $cputype = 'rv64' if $arch eq 'riscv64';
-    $cputype = 'la464' if $arch eq 'loongarch64';
-    }
-
-    return $cputype;
+    my %cpu_map = (
+        'x86_64'      => $kvm ? 'kvm64' : 'qemu64',
+        'aarch64'     => $kvm ? 'host' : 'max',
+        'riscv64'     => $kvm ? 'rv64' : 'max',
+        'loongarch64' => $kvm ? 'la464' : 'max',
+    );
+
+    return $cpu_map{$arch} // 'max';
 }
 
 sub is_native_arch($) {
diff --git a/PVE/QemuServer/PCI.pm b/PVE/QemuServer/PCI.pm
index 15c18691..c4efd943 100644
--- a/PVE/QemuServer/PCI.pm
+++ b/PVE/QemuServer/PCI.pm
@@ -296,91 +296,91 @@ sub get_pci_addr_map {
 			#addr29 : usb-host (pve-usb.cfg)
 			'pci.1' => { bus => 0, addr => 30 },
 			'pci.2' => { bus => 0, addr => 31 },
-			'net6' => { bus => 2, addr => 1 },
-			'net7' => { bus => 2, addr => 2 },
-			'net8' => { bus => 2, addr => 3 },
-			'net9' => { bus => 2, addr => 4 },
-			'net10' => { bus => 2, addr => 5 },
-			'net11' => { bus => 2, addr => 6 },
-			'net12' => { bus => 2, addr => 7 },
-			'net13' => { bus => 2, addr => 8 },
-			'net14' => { bus => 2, addr => 9 },
-			'net15' => { bus => 2, addr => 10 },
-			'net16' => { bus => 2, addr => 11 },
-			'net17' => { bus => 2, addr => 12 },
-			'net18' => { bus => 2, addr => 13 },
-			'net19' => { bus => 2, addr => 14 },
-			'net20' => { bus => 2, addr => 15 },
-			'net21' => { bus => 2, addr => 16 },
-			'net22' => { bus => 2, addr => 17 },
-			'net23' => { bus => 2, addr => 18 },
-			'net24' => { bus => 2, addr => 19 },
-			'net25' => { bus => 2, addr => 20 },
-			'net26' => { bus => 2, addr => 21 },
-			'net27' => { bus => 2, addr => 22 },
-			'net28' => { bus => 2, addr => 23 },
-			'net29' => { bus => 2, addr => 24 },
-			'net30' => { bus => 2, addr => 25 },
-			'net31' => { bus => 2, addr => 26 },
-			'xhci' => { bus => 2, addr => 27 },
-			'pci.4' => { bus => 2, addr => 28 },
-			'rng0' => { bus => 2, addr => 29 },
-			'pci.2-igd' => { bus => 2, addr => 30 }, # replaces pci.2 in case a legacy IGD device is passed through
-			'virtio6' => { bus => 3, addr => 1 },
-			'virtio7' => { bus => 3, addr => 2 },
-			'virtio8' => { bus => 3, addr => 3 },
-			'virtio9' => { bus => 3, addr => 4 },
-			'virtio10' => { bus => 3, addr => 5 },
-			'virtio11' => { bus => 3, addr => 6 },
-			'virtio12' => { bus => 3, addr => 7 },
-			'virtio13' => { bus => 3, addr => 8 },
-			'virtio14' => { bus => 3, addr => 9 },
-			'virtio15' => { bus => 3, addr => 10 },
-			'ivshmem' => { bus => 3, addr => 11 },
-			'audio0' => { bus => 3, addr => 12 },
-			hostpci4 => { bus => 3, addr => 13 },
-			hostpci5 => { bus => 3, addr => 14 },
-			hostpci6 => { bus => 3, addr => 15 },
-			hostpci7 => { bus => 3, addr => 16 },
-			hostpci8 => { bus => 3, addr => 17 },
-			hostpci9 => { bus => 3, addr => 18 },
-			hostpci10 => { bus => 3, addr => 19 },
-			hostpci11 => { bus => 3, addr => 20 },
-			hostpci12 => { bus => 3, addr => 21 },
-			hostpci13 => { bus => 3, addr => 22 },
-			hostpci14 => { bus => 3, addr => 23 },
-			hostpci15 => { bus => 3, addr => 24 },
-			'virtioscsi0' => { bus => 4, addr => 1 },
-			'virtioscsi1' => { bus => 4, addr => 2 },
-			'virtioscsi2' => { bus => 4, addr => 3 },
-			'virtioscsi3' => { bus => 4, addr => 4 },
-			'virtioscsi4' => { bus => 4, addr => 5 },
-			'virtioscsi5' => { bus => 4, addr => 6 },
-			'virtioscsi6' => { bus => 4, addr => 7 },
-			'virtioscsi7' => { bus => 4, addr => 8 },
-			'virtioscsi8' => { bus => 4, addr => 9 },
-			'virtioscsi9' => { bus => 4, addr => 10 },
-			'virtioscsi10' => { bus => 4, addr => 11 },
-			'virtioscsi11' => { bus => 4, addr => 12 },
-			'virtioscsi12' => { bus => 4, addr => 13 },
-			'virtioscsi13' => { bus => 4, addr => 14 },
-			'virtioscsi14' => { bus => 4, addr => 15 },
-			'virtioscsi15' => { bus => 4, addr => 16 },
-			'virtioscsi16' => { bus => 4, addr => 17 },
-			'virtioscsi17' => { bus => 4, addr => 18 },
-			'virtioscsi18' => { bus => 4, addr => 19 },
-			'virtioscsi19' => { bus => 4, addr => 20 },
-			'virtioscsi20' => { bus => 4, addr => 21 },
-			'virtioscsi21' => { bus => 4, addr => 22 },
-			'virtioscsi22' => { bus => 4, addr => 23 },
-			'virtioscsi23' => { bus => 4, addr => 24 },
-			'virtioscsi24' => { bus => 4, addr => 25 },
-			'virtioscsi25' => { bus => 4, addr => 26 },
-			'virtioscsi26' => { bus => 4, addr => 27 },
-			'virtioscsi27' => { bus => 4, addr => 28 },
-			'virtioscsi28' => { bus => 4, addr => 29 },
-			'virtioscsi29' => { bus => 4, addr => 30 },
-			'virtioscsi30' => { bus => 4, addr => 31 },
+			'net6' => { bus => 1, addr => 1 },
+			'net7' => { bus => 1, addr => 2 },
+			'net8' => { bus => 1, addr => 3 },
+			'net9' => { bus => 1, addr => 4 },
+			'net10' => { bus => 1, addr => 5 },
+			'net11' => { bus => 1, addr => 6 },
+			'net12' => { bus => 1, addr => 7 },
+			'net13' => { bus => 1, addr => 8 },
+			'net14' => { bus => 1, addr => 9 },
+			'net15' => { bus => 1, addr => 10 },
+			'net16' => { bus => 1, addr => 11 },
+			'net17' => { bus => 1, addr => 12 },
+			'net18' => { bus => 1, addr => 13 },
+			'net19' => { bus => 1, addr => 14 },
+			'net20' => { bus => 1, addr => 15 },
+			'net21' => { bus => 1, addr => 16 },
+			'net22' => { bus => 1, addr => 17 },
+			'net23' => { bus => 1, addr => 18 },
+			'net24' => { bus => 1, addr => 19 },
+			'net25' => { bus => 1, addr => 20 },
+			'net26' => { bus => 1, addr => 21 },
+			'net27' => { bus => 1, addr => 22 },
+			'net28' => { bus => 1, addr => 23 },
+			'net29' => { bus => 1, addr => 24 },
+			'net30' => { bus => 1, addr => 25 },
+			'net31' => { bus => 1, addr => 26 },
+			'xhci' => { bus => 1, addr => 27 },
+			'pci.4' => { bus => 1, addr => 28 },
+			'rng0' => { bus => 1, addr => 29 },
+			'pci.2-igd' => { bus => 1, addr => 30 }, # replaces pci.2 in case a legacy IGD device is passed through
+			'virtio6' => { bus => 2, addr => 1 },
+			'virtio7' => { bus => 2, addr => 2 },
+			'virtio8' => { bus => 2, addr => 3 },
+			'virtio9' => { bus => 2, addr => 4 },
+			'virtio10' => { bus => 2, addr => 5 },
+			'virtio11' => { bus => 2, addr => 6 },
+			'virtio12' => { bus => 2, addr => 7 },
+			'virtio13' => { bus => 2, addr => 8 },
+			'virtio14' => { bus => 2, addr => 9 },
+			'virtio15' => { bus => 2, addr => 10 },
+			'ivshmem' => { bus => 2, addr => 11 },
+			'audio0' => { bus => 2, addr => 12 },
+			hostpci4 => { bus => 2, addr => 13 },
+			hostpci5 => { bus => 2, addr => 14 },
+			hostpci6 => { bus => 2, addr => 15 },
+			hostpci7 => { bus => 2, addr => 16 },
+			hostpci8 => { bus => 2, addr => 17 },
+			hostpci9 => { bus => 2, addr => 18 },
+			hostpci10 => { bus => 2, addr => 19 },
+			hostpci11 => { bus => 2, addr => 20 },
+			hostpci12 => { bus => 2, addr => 21 },
+			hostpci13 => { bus => 2, addr => 22 },
+			hostpci14 => { bus => 2, addr => 23 },
+			hostpci15 => { bus => 2, addr => 24 },
+			'virtioscsi0' => { bus => 3, addr => 1 },
+			'virtioscsi1' => { bus => 3, addr => 2 },
+			'virtioscsi2' => { bus => 3, addr => 3 },
+			'virtioscsi3' => { bus => 3, addr => 4 },
+			'virtioscsi4' => { bus => 3, addr => 5 },
+			'virtioscsi5' => { bus => 3, addr => 6 },
+			'virtioscsi6' => { bus => 3, addr => 7 },
+			'virtioscsi7' => { bus => 3, addr => 8 },
+			'virtioscsi8' => { bus => 3, addr => 9 },
+			'virtioscsi9' => { bus => 3, addr => 10 },
+			'virtioscsi10' => { bus => 3, addr => 11 },
+			'virtioscsi11' => { bus => 3, addr => 12 },
+			'virtioscsi12' => { bus => 3, addr => 13 },
+			'virtioscsi13' => { bus => 3, addr => 14 },
+			'virtioscsi14' => { bus => 3, addr => 15 },
+			'virtioscsi15' => { bus => 3, addr => 16 },
+			'virtioscsi16' => { bus => 3, addr => 17 },
+			'virtioscsi17' => { bus => 3, addr => 18 },
+			'virtioscsi18' => { bus => 3, addr => 19 },
+			'virtioscsi19' => { bus => 3, addr => 20 },
+			'virtioscsi20' => { bus => 3, addr => 21 },
+			'virtioscsi21' => { bus => 3, addr => 22 },
+			'virtioscsi22' => { bus => 3, addr => 23 },
+			'virtioscsi23' => { bus => 3, addr => 24 },
+			'virtioscsi24' => { bus => 3, addr => 25 },
+			'virtioscsi25' => { bus => 3, addr => 26 },
+			'virtioscsi26' => { bus => 3, addr => 27 },
+			'virtioscsi27' => { bus => 3, addr => 28 },
+			'virtioscsi28' => { bus => 3, addr => 29 },
+			'virtioscsi29' => { bus => 3, addr => 30 },
+			'virtioscsi30' => { bus => 3, addr => 31 },
 			'scsihw2' => { bus => 4, addr => 1 },
 			'scsihw3' => { bus => 4, addr => 2 },
 			'scsihw4' => { bus => 4, addr => 3 },
-- 
2.39.5

