From d2c0ec81c00ca6d2a1062af2dfb43b8390e3bf6b Mon Sep 17 00:00:00 2001
From: jiangcuo <jiangcuo@bingsin.com>
Date: Mon, 3 Feb 2025 12:36:05 +0800
Subject: [PATCH 1/9] remap pcie addr on port

---
 PVE/QemuServer/PCI.pm     | 416 ++++++++++++++++++++++++++------------
 PVE/QemuServer/USB.pm     |  32 ++-
 qemu-configs/Makefile     |   3 +-
 qemu-configs/pve-port.cfg |  48 +++++
 4 files changed, 362 insertions(+), 137 deletions(-)
 create mode 100644 qemu-configs/pve-port.cfg

diff --git a/PVE/QemuServer/PCI.pm b/PVE/QemuServer/PCI.pm
index d758ae9d..15c18691 100644
--- a/PVE/QemuServer/PCI.pm
+++ b/PVE/QemuServer/PCI.pm
@@ -14,6 +14,7 @@ our @EXPORT_OK = qw(
 print_pci_addr
 print_pcie_addr
 print_pcie_root_port
+print_pcie_root_port_for_port
 parse_hostpci
 );
 
@@ -138,131 +139,254 @@ PVE::JSONSchema::register_standard_option("pve-qm-hostpci", $hostpcidesc);
 
 my $pci_addr_map;
 sub get_pci_addr_map {
-    $pci_addr_map = {
-	piix3 => { bus => 0, addr => 1, conflict_ok => qw(ehci)  },
-	ehci => { bus => 0, addr => 1, conflict_ok => qw(piix3) }, # instead of piix3 on arm
-	vga => { bus => 0, addr => 2, conflict_ok => qw(legacy-igd) },
-	'legacy-igd' => { bus => 0, addr => 2, conflict_ok => qw(vga) }, # legacy-igd requires vga=none
-	balloon0 => { bus => 0, addr => 3 },
-	watchdog => { bus => 0, addr => 4 },
-	scsihw0 => { bus => 0, addr => 5, conflict_ok => qw(pci.3) },
-	'pci.3' => { bus => 0, addr => 5, conflict_ok => qw(scsihw0) }, # also used for virtio-scsi-single bridge
-	scsihw1 => { bus => 0, addr => 6 },
-	ahci0 => { bus => 0, addr => 7 },
-	qga0 => { bus => 0, addr => 8 },
-	spice => { bus => 0, addr => 9 },
-	virtio0 => { bus => 0, addr => 10 },
-	virtio1 => { bus => 0, addr => 11 },
-	virtio2 => { bus => 0, addr => 12 },
-	virtio3 => { bus => 0, addr => 13 },
-	virtio4 => { bus => 0, addr => 14 },
-	virtio5 => { bus => 0, addr => 15 },
-	hostpci0 => { bus => 0, addr => 16 },
-	hostpci1 => { bus => 0, addr => 17 },
-	net0 => { bus => 0, addr => 18 },
-	net1 => { bus => 0, addr => 19 },
-	net2 => { bus => 0, addr => 20 },
-	net3 => { bus => 0, addr => 21 },
-	net4 => { bus => 0, addr => 22 },
-	net5 => { bus => 0, addr => 23 },
-	vga1 => { bus => 0, addr => 24 },
-	vga2 => { bus => 0, addr => 25 },
-	vga3 => { bus => 0, addr => 26 },
-	hostpci2 => { bus => 0, addr => 27 },
-	hostpci3 => { bus => 0, addr => 28 },
-	#addr29 : usb-host (pve-usb.cfg)
-	'pci.1' => { bus => 0, addr => 30 },
-	'pci.2' => { bus => 0, addr => 31 },
-	'net6' => { bus => 1, addr => 1 },
-	'net7' => { bus => 1, addr => 2 },
-	'net8' => { bus => 1, addr => 3 },
-	'net9' => { bus => 1, addr => 4 },
-	'net10' => { bus => 1, addr => 5 },
-	'net11' => { bus => 1, addr => 6 },
-	'net12' => { bus => 1, addr => 7 },
-	'net13' => { bus => 1, addr => 8 },
-	'net14' => { bus => 1, addr => 9 },
-	'net15' => { bus => 1, addr => 10 },
-	'net16' => { bus => 1, addr => 11 },
-	'net17' => { bus => 1, addr => 12 },
-	'net18' => { bus => 1, addr => 13 },
-	'net19' => { bus => 1, addr => 14 },
-	'net20' => { bus => 1, addr => 15 },
-	'net21' => { bus => 1, addr => 16 },
-	'net22' => { bus => 1, addr => 17 },
-	'net23' => { bus => 1, addr => 18 },
-	'net24' => { bus => 1, addr => 19 },
-	'net25' => { bus => 1, addr => 20 },
-	'net26' => { bus => 1, addr => 21 },
-	'net27' => { bus => 1, addr => 22 },
-	'net28' => { bus => 1, addr => 23 },
-	'net29' => { bus => 1, addr => 24 },
-	'net30' => { bus => 1, addr => 25 },
-	'net31' => { bus => 1, addr => 26 },
-	'xhci' => { bus => 1, addr => 27 },
-	'pci.4' => { bus => 1, addr => 28 },
-	'rng0' => { bus => 1, addr => 29 },
-	'pci.2-igd' => { bus => 1, addr => 30 }, # replaces pci.2 in case a legacy IGD device is passed through
-	'virtio6' => { bus => 2, addr => 1 },
-	'virtio7' => { bus => 2, addr => 2 },
-	'virtio8' => { bus => 2, addr => 3 },
-	'virtio9' => { bus => 2, addr => 4 },
-	'virtio10' => { bus => 2, addr => 5 },
-	'virtio11' => { bus => 2, addr => 6 },
-	'virtio12' => { bus => 2, addr => 7 },
-	'virtio13' => { bus => 2, addr => 8 },
-	'virtio14' => { bus => 2, addr => 9 },
-	'virtio15' => { bus => 2, addr => 10 },
-	'ivshmem' => { bus => 2, addr => 11 },
-	'audio0' => { bus => 2, addr => 12 },
-	hostpci4 => { bus => 2, addr => 13 },
-	hostpci5 => { bus => 2, addr => 14 },
-	hostpci6 => { bus => 2, addr => 15 },
-	hostpci7 => { bus => 2, addr => 16 },
-	hostpci8 => { bus => 2, addr => 17 },
-	hostpci9 => { bus => 2, addr => 18 },
-	hostpci10 => { bus => 2, addr => 19 },
-	hostpci11 => { bus => 2, addr => 20 },
-	hostpci12 => { bus => 2, addr => 21 },
-	hostpci13 => { bus => 2, addr => 22 },
-	hostpci14 => { bus => 2, addr => 23 },
-	hostpci15 => { bus => 2, addr => 24 },
-	'virtioscsi0' => { bus => 3, addr => 1 },
-	'virtioscsi1' => { bus => 3, addr => 2 },
-	'virtioscsi2' => { bus => 3, addr => 3 },
-	'virtioscsi3' => { bus => 3, addr => 4 },
-	'virtioscsi4' => { bus => 3, addr => 5 },
-	'virtioscsi5' => { bus => 3, addr => 6 },
-	'virtioscsi6' => { bus => 3, addr => 7 },
-	'virtioscsi7' => { bus => 3, addr => 8 },
-	'virtioscsi8' => { bus => 3, addr => 9 },
-	'virtioscsi9' => { bus => 3, addr => 10 },
-	'virtioscsi10' => { bus => 3, addr => 11 },
-	'virtioscsi11' => { bus => 3, addr => 12 },
-	'virtioscsi12' => { bus => 3, addr => 13 },
-	'virtioscsi13' => { bus => 3, addr => 14 },
-	'virtioscsi14' => { bus => 3, addr => 15 },
-	'virtioscsi15' => { bus => 3, addr => 16 },
-	'virtioscsi16' => { bus => 3, addr => 17 },
-	'virtioscsi17' => { bus => 3, addr => 18 },
-	'virtioscsi18' => { bus => 3, addr => 19 },
-	'virtioscsi19' => { bus => 3, addr => 20 },
-	'virtioscsi20' => { bus => 3, addr => 21 },
-	'virtioscsi21' => { bus => 3, addr => 22 },
-	'virtioscsi22' => { bus => 3, addr => 23 },
-	'virtioscsi23' => { bus => 3, addr => 24 },
-	'virtioscsi24' => { bus => 3, addr => 25 },
-	'virtioscsi25' => { bus => 3, addr => 26 },
-	'virtioscsi26' => { bus => 3, addr => 27 },
-	'virtioscsi27' => { bus => 3, addr => 28 },
-	'virtioscsi28' => { bus => 3, addr => 29 },
-	'virtioscsi29' => { bus => 3, addr => 30 },
-	'virtioscsi30' => { bus => 3, addr => 31 },
-	'scsihw2' => { bus => 4, addr => 1 },
-	'scsihw3' => { bus => 4, addr => 2 },
-	'scsihw4' => { bus => 4, addr => 3 },
-    } if !defined($pci_addr_map);
-    return $pci_addr_map;
+	my ($arch) = @_;
+	if ($arch ne 'x86_64'){
+		$pci_addr_map = {
+			piix3 => { bus => 0, addr => 1, conflict_ok => qw(ehci)  },
+			ehci => { bus => 0, addr => 1, conflict_ok => qw(piix3) }, # instead of piix3 on arm
+			vga => { bus => 0, addr => 2, conflict_ok => qw(legacy-igd) },
+			'legacy-igd' => { bus => 0, addr => 2, conflict_ok => qw(vga) }, # legacy-igd requires vga=none
+			balloon0 => { bus => 0, addr => 3 },
+			watchdog => { bus => 0, addr => 4 },
+			scsihw0 => { bus => 0, addr => 5 },
+			scsihw1 => { bus => 0, addr => 6 },
+			ahci0 => { bus => 0, addr => 7 },
+			qga0 => { bus => 0, addr => 8 },
+			spice => { bus => 0, addr => 9 },
+			# net0 will not be hotpluged, This is a legacy issue, and if the addr is modified during the update, 
+			# it may cause the guest to lose internet access.
+			# So we reserved this address for net0.
+			# If you wan't eth0 support hotplug, please refer to the comments below
+			'net0' => { bus => 0, addr => 11 }, 
+			# pci 1 -> pcie.1 bus => 0, addr => 12 for net hotplug
+			# pci 2 -> pcie.1 bus => 0, addr => 13 for virtio hotplug
+			# pci 3 -> pcie.1 bus => 0, addr => 14 for virtioscsi0 hotplug
+			# pci 4 -> pcie.1 bus => 0, addr => 15. Keep it for later, maybe it will be used by nvme
+			hostpci0 => { bus => 5, addr => 0 },  	# pcie-port 5 -> pcie.5 bus => 0, addr => 16
+			hostpci1 => { bus => 6, addr => 0 },    # pcie-port 6 -> pcie.6 bus => 0, addr => 17
+			hostpci2 => { bus => 7, addr => 0 },    # pcie-port 7 -> pcie.7 bus => 0, addr => 18
+			hostpci3 => { bus => 8, addr => 0 },    # pcie-port 8 -> pcie.8 bus => 0, addr => 19
+			hostpci4 => { bus => 9, addr => 0 },    # pcie-port 9 -> pcie.9 bus => 0, addr => 20
+			hostpci5 => { bus => 10, addr => 0 },   # pcie-port 10 -> pcie.10 bus => 0, addr => 21
+			hostpci6 => { bus => 11, addr => 0 },   # pcie-port 11 -> pcie.11 bus => 0, addr => 22
+			hostpci7 => { bus => 12, addr => 0 },   # pcie-port 12 -> pcie.12 bus => 0, addr => 23
+			hostpci8 => { bus => 13, addr => 0 },   # pcie-port 13 -> pcie.13 bus => 0, addr => 24
+			hostpci9 => { bus => 14, addr => 0 },   # pcie-port 14 -> pcie.14 bus => 0, addr => 25 
+			hostpci10 => { bus => 15, addr => 0 },  # pcie-port 15 -> pcie.15 bus => 0, addr => 26 
+			hostpci11 => { bus => 16, addr => 0 },  # pcie-port 16 -> pcie.16 bus => 0, addr => 27 
+			hostpci12 => { bus => 17, addr => 0 },  # pcie-port 17 -> pcie.17 bus => 0, addr => 28 
+			hostpci13 => { bus => 18, addr => 0 },  # pcie-port 18 -> pcie.18 bus => 0, addr => 29 
+			hostpci14 => { bus => 19, addr => 0 },  # pcie-port 19 -> pcie.19 bus => 0, addr => 30 
+			'rng0' => { bus => 0, addr => 31 },
+			'xhci' => { bus => 1, addr => 1 }, # This support usbX hotplug
+			# 'net0' => { bus => 1, addr => 3 }, This support net0 hotplug
+			'net1' => { bus => 1, addr => 4 },
+			'net2' => { bus => 1, addr => 5 },
+			'net3' => { bus => 1, addr => 6 },
+			'net4' => { bus => 1, addr => 7 },
+			'net5' => { bus => 1, addr => 8 },
+			'net6' => { bus => 1, addr => 9 },
+			'net7' => { bus => 1, addr => 10 },
+			'net8' => { bus => 1, addr => 11 },
+			'net9' => { bus => 1, addr => 12 },
+			'net10' => { bus => 1, addr => 13 },
+			'net11' => { bus => 1, addr => 14 },
+			'net12' => { bus => 1, addr => 15 },
+			'net13' => { bus => 1, addr => 16 },
+			'net14' => { bus => 1, addr => 17 },
+			'net15' => { bus => 1, addr => 18 },
+			'net16' => { bus => 1, addr => 19 },
+			'net17' => { bus => 1, addr => 20 },
+			'net18' => { bus => 1, addr => 21 },
+			'net19' => { bus => 1, addr => 22 },
+			'net20' => { bus => 1, addr => 23 },
+			'net21' => { bus => 1, addr => 24 },
+			'net22' => { bus => 1, addr => 25 },
+			'net23' => { bus => 1, addr => 26 },
+			'net24' => { bus => 1, addr => 27 },	
+			vga1 => { bus => 1, addr => 28 },
+			vga2 => { bus => 1, addr => 29 },
+			'pci.2-igd' => { bus => 1, addr => 30 }, # replaces pci.2 in case a legacy IGD device is passed through
+			'virtio0' => { bus => 2, addr => 1 },
+			'virtio1' => { bus => 2, addr => 2 },
+			'virtio2' => { bus => 2, addr => 3 },
+			'virtio3' => { bus => 2, addr => 4 },
+			'virtio4' => { bus => 2, addr => 5 },
+			'virtio5' => { bus => 2, addr => 6 },
+			'virtio6' => { bus => 2, addr => 7 },
+			'virtio7' => { bus => 2, addr => 8 },
+			'virtio8' => { bus => 2, addr => 9 },
+			'virtio9' => { bus => 2, addr => 10 },
+			'virtio10' => { bus => 2, addr => 11 },
+			'virtio11' => { bus => 2, addr => 12 },
+			'virtio12' => { bus => 2, addr => 13 },
+			'virtio13' => { bus => 2, addr => 14 },
+			'virtio14' => { bus => 2, addr => 15 },
+			'virtio15' => { bus => 2, addr => 16 },
+			'ivshmem' => { bus => 2, addr => 17 },
+			'audio0' => { bus => 2, addr => 18 },
+			'scsihw2' => { bus => 2, addr => 19 },
+			'scsihw3' => { bus => 2, addr => 20 },
+			'scsihw4' => { bus => 2, addr => 21 },
+			'virtioscsi0' => { bus => 3, addr => 1 },
+			'virtioscsi1' => { bus => 3, addr => 2 },
+			'virtioscsi2' => { bus => 3, addr => 3 },
+			'virtioscsi3' => { bus => 3, addr => 4 },
+			'virtioscsi4' => { bus => 3, addr => 5 },
+			'virtioscsi5' => { bus => 3, addr => 6 },
+			'virtioscsi6' => { bus => 3, addr => 7 },
+			'virtioscsi7' => { bus => 3, addr => 8 },
+			'virtioscsi8' => { bus => 3, addr => 9 },
+			'virtioscsi9' => { bus => 3, addr => 10 },
+			'virtioscsi10' => { bus => 3, addr => 11 },
+			'virtioscsi11' => { bus => 3, addr => 12 },
+			'virtioscsi12' => { bus => 3, addr => 13 },
+			'virtioscsi13' => { bus => 3, addr => 14 },
+			'virtioscsi14' => { bus => 3, addr => 15 },
+			'virtioscsi15' => { bus => 3, addr => 16 },
+			'virtioscsi16' => { bus => 3, addr => 17 },
+			'virtioscsi17' => { bus => 3, addr => 18 },
+			'virtioscsi18' => { bus => 3, addr => 19 },
+			'virtioscsi19' => { bus => 3, addr => 20 },
+			'virtioscsi20' => { bus => 3, addr => 21 },
+			'virtioscsi21' => { bus => 3, addr => 22 },
+			'virtioscsi22' => { bus => 3, addr => 23 },
+			'virtioscsi23' => { bus => 3, addr => 24 },
+			'virtioscsi24' => { bus => 3, addr => 25 },
+			'virtioscsi25' => { bus => 3, addr => 26 },
+			'virtioscsi26' => { bus => 3, addr => 27 },
+			'virtioscsi27' => { bus => 3, addr => 28 },
+			'virtioscsi28' => { bus => 3, addr => 29 },
+			'virtioscsi29' => { bus => 3, addr => 30 },
+			'virtioscsi30' => { bus => 3, addr => 31 },
+		}
+		} else{
+		$pci_addr_map = {
+			piix3 => { bus => 0, addr => 1, conflict_ok => qw(ehci)  },
+			ehci => { bus => 0, addr => 1, conflict_ok => qw(piix3) }, # instead of piix3 on arm
+			vga => { bus => 0, addr => 2, conflict_ok => qw(legacy-igd) },
+			'legacy-igd' => { bus => 0, addr => 2, conflict_ok => qw(vga) }, # legacy-igd requires vga=none
+			balloon0 => { bus => 0, addr => 3 },
+			watchdog => { bus => 0, addr => 4 },
+			scsihw0 => { bus => 0, addr => 5, conflict_ok => qw(pci.3) },
+			'pci.3' => { bus => 0, addr => 5, conflict_ok => qw(scsihw0) }, # also used for virtio-scsi-single bridge
+			scsihw1 => { bus => 0, addr => 6 },
+			ahci0 => { bus => 0, addr => 7 },
+			qga0 => { bus => 0, addr => 8 },
+			spice => { bus => 0, addr => 9 },
+			virtio0 => { bus => 0, addr => 10 },
+			virtio1 => { bus => 0, addr => 11 },
+			virtio2 => { bus => 0, addr => 12 },
+			virtio3 => { bus => 0, addr => 13 },
+			virtio4 => { bus => 0, addr => 14 },
+			virtio5 => { bus => 0, addr => 15 },
+			hostpci0 => { bus => 0, addr => 16 },
+			hostpci1 => { bus => 0, addr => 17 },
+			net0 => { bus => 0, addr => 18 },
+			net1 => { bus => 0, addr => 19 },
+			net2 => { bus => 0, addr => 20 },
+			net3 => { bus => 0, addr => 21 },
+			net4 => { bus => 0, addr => 22 },
+			net5 => { bus => 0, addr => 23 },
+			vga1 => { bus => 0, addr => 24 },
+			vga2 => { bus => 0, addr => 25 },
+			vga3 => { bus => 0, addr => 26 },
+			hostpci2 => { bus => 0, addr => 27 },
+			hostpci3 => { bus => 0, addr => 28 },
+			#addr29 : usb-host (pve-usb.cfg)
+			'pci.1' => { bus => 0, addr => 30 },
+			'pci.2' => { bus => 0, addr => 31 },
+			'net6' => { bus => 2, addr => 1 },
+			'net7' => { bus => 2, addr => 2 },
+			'net8' => { bus => 2, addr => 3 },
+			'net9' => { bus => 2, addr => 4 },
+			'net10' => { bus => 2, addr => 5 },
+			'net11' => { bus => 2, addr => 6 },
+			'net12' => { bus => 2, addr => 7 },
+			'net13' => { bus => 2, addr => 8 },
+			'net14' => { bus => 2, addr => 9 },
+			'net15' => { bus => 2, addr => 10 },
+			'net16' => { bus => 2, addr => 11 },
+			'net17' => { bus => 2, addr => 12 },
+			'net18' => { bus => 2, addr => 13 },
+			'net19' => { bus => 2, addr => 14 },
+			'net20' => { bus => 2, addr => 15 },
+			'net21' => { bus => 2, addr => 16 },
+			'net22' => { bus => 2, addr => 17 },
+			'net23' => { bus => 2, addr => 18 },
+			'net24' => { bus => 2, addr => 19 },
+			'net25' => { bus => 2, addr => 20 },
+			'net26' => { bus => 2, addr => 21 },
+			'net27' => { bus => 2, addr => 22 },
+			'net28' => { bus => 2, addr => 23 },
+			'net29' => { bus => 2, addr => 24 },
+			'net30' => { bus => 2, addr => 25 },
+			'net31' => { bus => 2, addr => 26 },
+			'xhci' => { bus => 2, addr => 27 },
+			'pci.4' => { bus => 2, addr => 28 },
+			'rng0' => { bus => 2, addr => 29 },
+			'pci.2-igd' => { bus => 2, addr => 30 }, # replaces pci.2 in case a legacy IGD device is passed through
+			'virtio6' => { bus => 3, addr => 1 },
+			'virtio7' => { bus => 3, addr => 2 },
+			'virtio8' => { bus => 3, addr => 3 },
+			'virtio9' => { bus => 3, addr => 4 },
+			'virtio10' => { bus => 3, addr => 5 },
+			'virtio11' => { bus => 3, addr => 6 },
+			'virtio12' => { bus => 3, addr => 7 },
+			'virtio13' => { bus => 3, addr => 8 },
+			'virtio14' => { bus => 3, addr => 9 },
+			'virtio15' => { bus => 3, addr => 10 },
+			'ivshmem' => { bus => 3, addr => 11 },
+			'audio0' => { bus => 3, addr => 12 },
+			hostpci4 => { bus => 3, addr => 13 },
+			hostpci5 => { bus => 3, addr => 14 },
+			hostpci6 => { bus => 3, addr => 15 },
+			hostpci7 => { bus => 3, addr => 16 },
+			hostpci8 => { bus => 3, addr => 17 },
+			hostpci9 => { bus => 3, addr => 18 },
+			hostpci10 => { bus => 3, addr => 19 },
+			hostpci11 => { bus => 3, addr => 20 },
+			hostpci12 => { bus => 3, addr => 21 },
+			hostpci13 => { bus => 3, addr => 22 },
+			hostpci14 => { bus => 3, addr => 23 },
+			hostpci15 => { bus => 3, addr => 24 },
+			'virtioscsi0' => { bus => 4, addr => 1 },
+			'virtioscsi1' => { bus => 4, addr => 2 },
+			'virtioscsi2' => { bus => 4, addr => 3 },
+			'virtioscsi3' => { bus => 4, addr => 4 },
+			'virtioscsi4' => { bus => 4, addr => 5 },
+			'virtioscsi5' => { bus => 4, addr => 6 },
+			'virtioscsi6' => { bus => 4, addr => 7 },
+			'virtioscsi7' => { bus => 4, addr => 8 },
+			'virtioscsi8' => { bus => 4, addr => 9 },
+			'virtioscsi9' => { bus => 4, addr => 10 },
+			'virtioscsi10' => { bus => 4, addr => 11 },
+			'virtioscsi11' => { bus => 4, addr => 12 },
+			'virtioscsi12' => { bus => 4, addr => 13 },
+			'virtioscsi13' => { bus => 4, addr => 14 },
+			'virtioscsi14' => { bus => 4, addr => 15 },
+			'virtioscsi15' => { bus => 4, addr => 16 },
+			'virtioscsi16' => { bus => 4, addr => 17 },
+			'virtioscsi17' => { bus => 4, addr => 18 },
+			'virtioscsi18' => { bus => 4, addr => 19 },
+			'virtioscsi19' => { bus => 4, addr => 20 },
+			'virtioscsi20' => { bus => 4, addr => 21 },
+			'virtioscsi21' => { bus => 4, addr => 22 },
+			'virtioscsi22' => { bus => 4, addr => 23 },
+			'virtioscsi23' => { bus => 4, addr => 24 },
+			'virtioscsi24' => { bus => 4, addr => 25 },
+			'virtioscsi25' => { bus => 4, addr => 26 },
+			'virtioscsi26' => { bus => 4, addr => 27 },
+			'virtioscsi27' => { bus => 4, addr => 28 },
+			'virtioscsi28' => { bus => 4, addr => 29 },
+			'virtioscsi29' => { bus => 4, addr => 30 },
+			'virtioscsi30' => { bus => 4, addr => 31 },
+			'scsihw2' => { bus => 4, addr => 1 },
+			'scsihw3' => { bus => 4, addr => 2 },
+			'scsihw4' => { bus => 4, addr => 3 },
+		}
+		}
+		return $pci_addr_map;
 }
 
 sub generate_mdev_uuid {
@@ -286,12 +410,12 @@ sub print_pci_addr {
 
     # using same bus slots on all HW, so we need to check special cases here:
     my $busname = 'pci';
-    if ($arch eq 'aarch64' && $machine =~ /^virt/) {
+    if ($arch ne 'x86_64' && $machine =~ /^virt/) {
 	die "aarch64/virt cannot use IDE devices\n" if $id =~ /^ide/;
 	$busname = 'pcie';
     }
 
-    my $map = get_pci_addr_map();
+    my $map = get_pci_addr_map($arch);
     if (my $d = $get_addr_mapping_from_id->($map, $id)) {
 	$res = ",bus=$busname.$d->{bus},addr=$d->{addr}";
 	$bridges->{$d->{bus}} = 1 if $bridges;
@@ -388,6 +512,39 @@ sub print_pcie_root_port {
     return $res;
 }
 
+sub print_pcie_root_port_for_port {
+    my ($i) = @_;
+    my $res = '';
+
+    my $root_port_addresses = {
+	 0 => "0x10",# hostpci0 -> pcie.5 
+	 1 => "0x11",# hostpci1 -> pcie.6 
+	 2 => "0x12",# hostpci2 -> pcie.7 
+	 3 => "0x13",# hostpci3 -> pcie.8 
+	 4 => "0x14",# hostpci4 -> pcie.9 
+	 5 => "0x15",# hostpci5 -> pcie.10 
+	 6 => "0x16",# hostpci6 -> pcie.11 
+	 7 => "0x17",# hostpci7 -> pcie.12 
+	 8 => "0x18",# hostpci8 -> pcie.13 
+	 9 => "0x19",# hostpci9 -> pcie.14 
+	 10 => "0x1a",# hostpci10 -> pcie.15 
+	 11 => "0x1b",# hostpci11 -> pcie.16 
+	 12 => "0x1c",# hostpci12 -> pcie.17 
+	 13 => "0x1d",# hostpci13 -> pcie.18 
+	 14 => "0x1e",# hostpci14 -> pcie.19 
+    };
+
+    if (defined($root_port_addresses->{$i})) {
+	my $id = $i + 5;
+	$res = "pcie-root-port,id=pcie.${id}";
+	$res .= ",addr=$root_port_addresses->{$i}";
+	$res .= ",x-speed=16,x-width=32,multifunction=on,bus=pcie.0";
+	$res .= ",port=${id},chassis=${id}";
+    }
+
+    return $res;
+}
+
 # returns the parsed pci config but parses the 'host' part into
 # a list if lists into the 'id' property like this:
 #
@@ -634,7 +791,6 @@ sub print_hostpci_devices {
     my $kvm_off = 0;
     my $gpu_passthrough = 0;
     my $legacy_igd = 0;
-
     my $pciaddr;
     my $pci_devices = choose_hostpci_devices(parse_hostpci_devices($conf), $vmid);
 
@@ -659,6 +815,10 @@ sub print_hostpci_devices {
 		$pciaddr = print_pcie_addr($id);
 	    }
 	} else {
+		# Aarch64 need pcie-root-port too! We try add it
+		if ($arch ne 'x86_64') {
+			push @$devices, '-device', print_pcie_root_port_for_port($i);
+		}
 	    my $pci_name = $d->{'legacy-igd'} ? 'legacy-igd' : $id;
 	    $pciaddr = print_pci_addr($pci_name, $bridges, $arch, $machine_type);
 	}
diff --git a/PVE/QemuServer/USB.pm b/PVE/QemuServer/USB.pm
index 017ef9c0..b2daab25 100644
--- a/PVE/QemuServer/USB.pm
+++ b/PVE/QemuServer/USB.pm
@@ -131,11 +131,21 @@ sub get_usb_controllers {
 
     my $use_qemu_xhci = min_version($machine_version, 7, 1)
 	&& defined($ostype) && ($ostype eq 'l26' || windows_version($ostype) > 7);
+	
+	# We use qemu_xhci only for !x86_64 device
+	if ($arch ne 'x86_64'){
+		$use_qemu_xhci = 1;
+	}
+
     my $is_q35 = PVE::QemuServer::Machine::machine_type_is_q35($conf);
 
-    if ($arch eq 'aarch64') {
+    if ($arch ne 'x86_64') {
         $pciaddr = print_pci_addr('ehci', $bridges, $arch, $machine);
-        push @$devices, '-device', "usb-ehci,id=ehci$pciaddr";
+		if (defined($ostype) && $ostype eq 'l26'){
+			push @$devices, '-device', "qemu-xhci,id=ehci$pciaddr";
+		}else{
+        	push @$devices, '-device', "usb-ehci,id=ehci$pciaddr";
+		}
     } elsif (!$is_q35) {
         $pciaddr = print_pci_addr("piix3", $bridges, $arch, $machine);
         push @$devices, '-device', "piix3-usb-uhci,id=uhci$pciaddr.0x2";
@@ -152,17 +162,23 @@ sub get_usb_controllers {
 	$use_usb2 = 1 if !$d->{usb3};
     }
 
-    if (!$use_qemu_xhci && !$is_q35 && $use_usb2 && $arch ne 'aarch64') {
+    if (!$use_qemu_xhci && !$is_q35 && $use_usb2 && $arch eq 'x86_64') {
 	# include usb device config if still on x86 before-xhci machines and if USB 3 is not used
 	push @$devices, '-readconfig', '/usr/share/qemu-server/pve-usb.cfg';
     }
 
     $pciaddr = print_pci_addr("xhci", $bridges, $arch, $machine);
-    if ($use_qemu_xhci && $any_usb) {
-	push @$devices, '-device', print_qemu_xhci_controller($pciaddr);
-    } elsif ($use_usb3) {
-	push @$devices, '-device', "nec-usb-xhci,id=xhci$pciaddr";
-    }
+	
+	if ($arch ne 'x86_64') {
+		#  Create the usb controller on first boot so that we don't need to hot-plug the device later.
+		push @$devices, '-device', print_qemu_xhci_controller($pciaddr);
+	}else{
+		if ($use_qemu_xhci && $any_usb) {
+		push @$devices, '-device', print_qemu_xhci_controller($pciaddr);
+		} elsif ($use_usb3) {
+		push @$devices, '-device', "nec-usb-xhci,id=xhci$pciaddr";
+		}
+	}
 
     return @$devices;
 }
diff --git a/qemu-configs/Makefile b/qemu-configs/Makefile
index f55e9bef..bccbc7e4 100644
--- a/qemu-configs/Makefile
+++ b/qemu-configs/Makefile
@@ -2,11 +2,12 @@ DESTDIR=
 USRSHAREDIR=$(DESTDIR)/usr/share/qemu-server
 
 .PHONY: install
-install: pve-usb.cfg pve-q35.cfg pve-q35-4.0.cfg
+install: pve-usb.cfg pve-q35.cfg pve-q35-4.0.cfg pve-port.cfg
 	install -d $(USRSHAREDIR)
 	install -m 0644 pve-usb.cfg $(USRSHAREDIR)
 	install -m 0644 pve-q35.cfg $(USRSHAREDIR)
 	install -m 0644 pve-q35-4.0.cfg $(USRSHAREDIR)
+	install -m 0644 pve-port.cfg $(USRSHAREDIR)
 
 .PHONY: clean
 clean:
diff --git a/qemu-configs/pve-port.cfg b/qemu-configs/pve-port.cfg
new file mode 100644
index 00000000..2d13bc63
--- /dev/null
+++ b/qemu-configs/pve-port.cfg
@@ -0,0 +1,48 @@
+[device "pci.1"]
+  driver = "pci-bridge"
+  bus = "pcie.0"
+  addr = "0xc"
+  chassis_nr = "1"
+
+[device "pci.2"]
+  driver = "pci-bridge"
+  bus = "pcie.0"
+  addr = "0xd"
+  chassis_nr = "2"
+
+[device "pci.3"]
+  driver = "pci-bridge"
+  bus = "pcie.0"
+  addr = "0xe"
+  chassis_nr = "3"
+
+[device "pci.4"]
+  driver = "pci-bridge"
+  bus = "pcie.0"
+  addr = "0xf"
+  chassis_nr = "4"
+
+[device "pcie.1"]
+  driver = "pci-bridge"
+  bus = "pci.1"
+  addr = "1.0"
+  chassis_nr = "1"
+
+[device "pcie.2"]
+  driver = "pci-bridge"
+  bus = "pci.2"
+  addr = "1.0"
+  chassis_nr = "1"
+
+[device "pcie.3"]
+  driver = "pci-bridge"
+  bus = "pci.3"
+  addr = "1.0"
+  chassis_nr = "1"
+
+[device "pcie.4"]
+  driver = "pci-bridge"
+  bus = "pci.4"
+  addr = "1.0"
+  chassis_nr = "1"
+
-- 
2.39.5

